<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Featured Stocks Dashboard - RELIANCE, TCS, INFY</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .stock-card {
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .stock-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
        }
        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .quarterly-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .quarterly-table .table {
            margin-bottom: 0;
        }
        .quarterly-table .table th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            text-align: center;
            vertical-align: middle;
        }
        .quarterly-table .table td {
            vertical-align: middle;
            border-color: #e9ecef;
        }
        .quarterly-table .table tbody tr:hover {
            background-color: #f8f9fa;
        }
        .text-end {
            text-align: right !important;
        }
        .table-primary {
            background-color: rgba(13, 110, 253, 0.1) !important;
        }
        .table-success {
            background-color: rgba(25, 135, 84, 0.1) !important;
        }
        .table-info {
            background-color: rgba(13, 202, 240, 0.1) !important;
        }
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .nav-pills .nav-link {
            border-radius: 25px;
            margin: 0 5px;
        }
        .nav-pills .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .stock-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-chart-line me-2"></i>
                Featured Stocks Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">Back to All Stocks</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Header -->
        <div class="stock-header text-center">
            <h1><i class="fas fa-star me-3"></i>Featured Stocks Analysis</h1>
            <p class="mb-0">Comprehensive analysis of RELIANCE, TCS, and INFY</p>
        </div>

        <!-- Stock Cards Row -->
        <div class="row mb-4" id="stockCardsContainer">
            <div class="col-md-4">
                <div class="card stock-card h-100">
                    <div class="card-body text-center">
                        <div class="loading-spinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stock-card h-100">
                    <div class="card-body text-center">
                        <div class="loading-spinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stock-card h-100">
                    <div class="card-body text-center">
                        <div class="loading-spinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stock Details Tabs -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-pills" id="stockTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="reliance-tab" data-bs-toggle="pill" data-bs-target="#reliance" type="button" role="tab">
                                    <i class="fas fa-industry me-2"></i>RELIANCE
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="tcs-tab" data-bs-toggle="pill" data-bs-target="#tcs" type="button" role="tab">
                                    <i class="fas fa-laptop-code me-2"></i>TCS
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="infy-tab" data-bs-toggle="pill" data-bs-target="#infy" type="button" role="tab">
                                    <i class="fas fa-cogs me-2"></i>INFY
                                </button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content" id="stockTabContent">
                            <!-- RELIANCE Tab -->
                            <div class="tab-pane fade show active" id="reliance" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="chart-container">
                                            <h5><i class="fas fa-chart-line me-2"></i>Daily Price Chart - RELIANCE</h5>
                                            <canvas id="relianceChart" width="400" height="200"></canvas>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="chart-container">
                                            <h5><i class="fas fa-chart-pie me-2"></i>Key Metrics - RELIANCE</h5>
                                            <div id="relianceMetrics"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="quarterly-table">
                                    <div class="p-3 border-bottom bg-light">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Quarterly Results - RELIANCE</h5>
                                            <div>
                                                <span class="badge bg-secondary me-2">Standalone Figures in Crores</span>
                                                <button class="btn btn-sm btn-outline-primary me-2">
                                                    <i class="fas fa-exchange-alt me-1"></i>Toggle Consolidated
                                                </button>
                                                <button class="btn btn-sm btn-primary">
                                                    <i class="fas fa-chart-pie me-1"></i>PRODUCT SEGMENTS
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="relianceQuarterly"></div>
                                </div>
                            </div>

                            <!-- TCS Tab -->
                            <div class="tab-pane fade" id="tcs" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="chart-container">
                                            <h5><i class="fas fa-chart-line me-2"></i>Daily Price Chart - TCS</h5>
                                            <canvas id="tcsChart" width="400" height="200"></canvas>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="chart-container">
                                            <h5><i class="fas fa-chart-pie me-2"></i>Key Metrics - TCS</h5>
                                            <div id="tcsMetrics"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="quarterly-table">
                                    <div class="p-3 border-bottom bg-light">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Quarterly Results - TCS</h5>
                                            <div>
                                                <span class="badge bg-secondary me-2">Standalone Figures in Crores</span>
                                                <button class="btn btn-sm btn-outline-primary me-2">
                                                    <i class="fas fa-exchange-alt me-1"></i>Toggle Consolidated
                                                </button>
                                                <button class="btn btn-sm btn-primary">
                                                    <i class="fas fa-chart-pie me-1"></i>PRODUCT SEGMENTS
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="tcsQuarterly"></div>
                                </div>
                            </div>

                            <!-- INFY Tab -->
                            <div class="tab-pane fade" id="infy" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="chart-container">
                                            <h5><i class="fas fa-chart-line me-2"></i>Daily Price Chart - INFY</h5>
                                            <canvas id="infyChart" width="400" height="200"></canvas>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="chart-container">
                                            <h5><i class="fas fa-chart-pie me-2"></i>Key Metrics - INFY</h5>
                                            <div id="infyMetrics"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="quarterly-table">
                                    <div class="p-3 border-bottom bg-light">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Quarterly Results - INFY</h5>
                                            <div>
                                                <span class="badge bg-secondary me-2">Standalone Figures in Crores</span>
                                                <button class="btn btn-sm btn-outline-primary me-2">
                                                    <i class="fas fa-exchange-alt me-1"></i>Toggle Consolidated
                                                </button>
                                                <button class="btn btn-sm btn-primary">
                                                    <i class="fas fa-chart-pie me-1"></i>PRODUCT SEGMENTS
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="infyQuarterly"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let featuredStocks = [];
        let charts = {};

        // Load featured stocks on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadFeaturedStocks();
        });

        async function loadFeaturedStocks() {
            try {
                const response = await fetch('/api/stocks/featured');
                featuredStocks = await response.json();
                renderStockCards();
                loadStockDetails();
            } catch (error) {
                console.error('Error loading featured stocks:', error);
            }
        }

        function renderStockCards() {
            const container = document.getElementById('stockCardsContainer');
            container.innerHTML = '';

            featuredStocks.forEach((stock, index) => {
                const col = document.createElement('div');
                col.className = 'col-md-4';
                
                col.innerHTML = `
                    <div class="card stock-card h-100">
                        <div class="card-body text-center">
                            <h4 class="card-title text-primary">${stock.nse_symbol}</h4>
                            <h6 class="card-subtitle mb-2 text-muted">${stock.name}</h6>
                            <div class="metric-card">
                                <div class="metric-value">₹${formatNumber(stock.current_price || 0)}</div>
                                <div class="metric-label">Current Price</div>
                            </div>
                            <div class="row text-center">
                                <div class="col-6">
                                    <small class="text-muted">Market Cap</small><br>
                                    <strong>₹${formatMarketCap(stock.market_cap || 0)}</strong>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">P/E Ratio</small><br>
                                    <strong>${stock.pe_ratio || 'N/A'}</strong>
                                </div>
                            </div>
                            <div class="mt-3">
                                <span class="badge bg-primary me-1">${stock.sector || 'N/A'}</span>
                                <span class="badge bg-secondary">${stock.industry || 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(col);
            });
        }

        async function loadStockDetails() {
            for (const stock of featuredStocks) {
                await loadDailyPrices(stock.nse_symbol);
                await loadQuarterlyResults(stock.nse_symbol);
                loadKeyMetrics(stock.nse_symbol);
            }
        }

        async function loadDailyPrices(symbol) {
            try {
                const response = await fetch(`/api/stocks/${symbol}/ohlcv?days=365`);
                const data = await response.json();
                renderChart(symbol, data);
            } catch (error) {
                console.error(`Error loading daily prices for ${symbol}:`, error);
            }
        }

        async function loadQuarterlyResults(symbol) {
            try {
                console.log(`Loading quarterly results for ${symbol}...`);
                // Add timestamp to prevent caching
                const timestamp = new Date().getTime();
                const response = await fetch(`/api/stocks/${symbol}/quarterly-results?quarters=8&t=${timestamp}`);
                const data = await response.json();
                console.log(`Quarterly data for ${symbol}:`, data);
                renderQuarterlyTable(symbol, data);
            } catch (error) {
                console.error(`Error loading quarterly results for ${symbol}:`, error);
            }
        }

        function loadKeyMetrics(symbol) {
            const stock = featuredStocks.find(s => s.nse_symbol === symbol);
            if (!stock) return;

            const container = document.getElementById(`${symbol.toLowerCase()}Metrics`);
            container.innerHTML = `
                <div class="row g-2">
                    <div class="col-6">
                        <div class="text-center p-2 bg-light rounded">
                            <div class="fw-bold text-primary">${stock.pe_ratio || 'N/A'}</div>
                            <small class="text-muted">P/E Ratio</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center p-2 bg-light rounded">
                            <div class="fw-bold text-success">${stock.pb_ratio || 'N/A'}</div>
                            <small class="text-muted">P/B Ratio</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center p-2 bg-light rounded">
                            <div class="fw-bold text-info">${stock.roce || 'N/A'}%</div>
                            <small class="text-muted">ROCE</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center p-2 bg-light rounded">
                            <div class="fw-bold text-warning">${stock.roe || 'N/A'}%</div>
                            <small class="text-muted">ROE</small>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderChart(symbol, data) {
            const ctx = document.getElementById(`${symbol.toLowerCase()}Chart`).getContext('2d');
            
            if (charts[symbol]) {
                charts[symbol].destroy();
            }

            const chartData = {
                labels: data.data.map(item => item.date),
                datasets: [{
                    label: 'Close Price',
                    data: data.data.map(item => item.close),
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                }]
            };

            charts[symbol] = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        function renderQuarterlyTable(symbol, data) {
            console.log(`Rendering quarterly table for ${symbol} with data:`, data);
            const container = document.getElementById(`${symbol.toLowerCase()}Quarterly`);
            console.log(`Container found:`, container);
            
            if (!data || data.length === 0) {
                console.log(`No data for ${symbol}, showing empty message`);
                container.innerHTML = '<div class="p-3 text-center text-muted">No quarterly data available</div>';
                return;
            }

            let tableHTML = `
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="min-width: 120px;">Financial Metrics</th>
            `;

            // Add quarter headers
            data.forEach(result => {
                tableHTML += `<th class="text-center">${result.quarter}</th>`;
            });

            tableHTML += `
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Sales/Revenue Row
            tableHTML += `
                <tr>
                    <td><strong>Sales</strong></td>
            `;
            data.forEach(result => {
                console.log(`Revenue for ${result.quarter}:`, result.revenue);
                tableHTML += `<td class="text-end">${formatNumber(result.revenue || 0)}</td>`;
            });
            tableHTML += `</tr>`;

            // Expenditure Row
            tableHTML += `
                <tr>
                    <td>Expenditure</td>
            `;
            data.forEach(result => {
                tableHTML += `<td class="text-end">${formatNumber(result.expenditure || 0)}</td>`;
            });
            tableHTML += `</tr>`;

            // Operating Profit Row
            tableHTML += `
                <tr class="table-primary">
                    <td><strong>Operating Profit</strong></td>
            `;
            data.forEach(result => {
                tableHTML += `<td class="text-end"><strong>${formatNumber(result.operating_profit || 0)}</strong></td>`;
            });
            tableHTML += `</tr>`;

            // OPM % Row
            tableHTML += `
                <tr>
                    <td>OPM %</td>
            `;
            data.forEach(result => {
                tableHTML += `<td class="text-end">${result.opm_percent || 'N/A'}%</td>`;
            });
            tableHTML += `</tr>`;

            // Other Income Row
            tableHTML += `
                <tr>
                    <td>Other Income</td>
            `;
            data.forEach(result => {
                tableHTML += `<td class="text-end">${formatNumber(result.other_income || 0)}</td>`;
            });
            tableHTML += `</tr>`;

            // Interest Row
            tableHTML += `
                <tr>
                    <td>Interest</td>
            `;
            data.forEach(result => {
                tableHTML += `<td class="text-end">${formatNumber(result.interest || 0)}</td>`;
            });
            tableHTML += `</tr>`;

            // Depreciation Row
            tableHTML += `
                <tr>
                    <td>Depreciation</td>
            `;
            data.forEach(result => {
                tableHTML += `<td class="text-end">${formatNumber(result.depreciation || 0)}</td>`;
            });
            tableHTML += `</tr>`;

            // Profit Before Tax Row
            tableHTML += `
                <tr class="table-success">
                    <td><strong>Profit before tax</strong></td>
            `;
            data.forEach(result => {
                tableHTML += `<td class="text-end"><strong>${formatNumber(result.pbt || 0)}</strong></td>`;
            });
            tableHTML += `</tr>`;

            // Tax % Row
            tableHTML += `
                <tr>
                    <td>Tax %</td>
            `;
            data.forEach(result => {
                tableHTML += `<td class="text-end">${result.tax_percent || 'N/A'}%</td>`;
            });
            tableHTML += `</tr>`;

            // Net Profit Row
            tableHTML += `
                <tr class="table-info">
                    <td><strong>Net Profit</strong></td>
            `;
            data.forEach(result => {
                tableHTML += `<td class="text-end"><strong>${formatNumber(result.net_profit || 0)}</strong></td>`;
            });
            tableHTML += `</tr>`;

            // EBITDA Row
            tableHTML += `
                <tr>
                    <td>EBITDA</td>
            `;
            data.forEach(result => {
                tableHTML += `<td class="text-end">${formatNumber(result.ebitda || 0)}</td>`;
            });
            tableHTML += `</tr>`;

            // EPS Row
            tableHTML += `
                <tr>
                    <td>EPS in Rs</td>
            `;
            data.forEach(result => {
                tableHTML += `<td class="text-end">${result.eps || 'N/A'}</td>`;
            });
            tableHTML += `</tr>`;

            // CEPS Row
            tableHTML += `
                <tr>
                    <td>CEPS in Rs</td>
            `;
            data.forEach(result => {
                tableHTML += `<td class="text-end">${result.ceps || 'N/A'}</td>`;
            });
            tableHTML += `</tr>`;

            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = tableHTML;
        }

        function formatNumber(num) {
            if (num === null || num === undefined) return 'N/A';
            // Values are already in crores, format with 2 decimal places
            return new Intl.NumberFormat('en-IN', { 
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2 
            }).format(num);
        }

        function formatMarketCap(marketCap) {
            if (!marketCap) return 'N/A';
            if (marketCap >= 10000000) return (marketCap / 10000000).toFixed(2) + ' Cr';
            if (marketCap >= 100000) return (marketCap / 100000).toFixed(2) + ' L';
            return marketCap.toString();
        }
    </script>
</body>
</html>
