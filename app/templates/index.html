<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Analysis Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .stock-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .stock-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .sector-badge {
            font-size: 0.8rem;
        }
        .price-change-positive { color: #28a745; }
        .price-change-negative { color: #dc3545; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-chart-line me-2"></i>
                Stock Analysis Dashboard
            </a>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-md-6">
                <h2>Nifty 50 Stocks</h2>
                <p class="text-muted">Comprehensive analysis of Indian stock market</p>
            </div>
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" class="form-control" id="searchInput" placeholder="Search stocks...">
                    <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-3">
                <select class="form-select" id="sectorFilter">
                    <option value="">All Sectors</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="industryFilter">
                    <option value="">All Industries</option>
                </select>
            </div>
        </div>

        <div class="row" id="stocksContainer">
            <!-- Stocks will be loaded here -->
        </div>

        <div class="text-center mt-4" id="loadingSpinner" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allStocks = [];
        let filteredStocks = [];

        // Load stocks on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadStocks();
            loadSectors();
        });

        async function loadStocks() {
            showLoading(true);
            try {
                const response = await fetch('/api/stocks?limit=100');
                allStocks = await response.json();
                filteredStocks = [...allStocks];
                renderStocks();
            } catch (error) {
                console.error('Error loading stocks:', error);
            } finally {
                showLoading(false);
            }
        }

        async function loadSectors() {
            try {
                const response = await fetch('/api/sectors');
                const sectors = await response.json();
                
                const sectorSelect = document.getElementById('sectorFilter');
                sectors.forEach(sector => {
                    const option = document.createElement('option');
                    option.value = sector;
                    option.textContent = sector;
                    sectorSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading sectors:', error);
            }
        }

        function renderStocks() {
            const container = document.getElementById('stocksContainer');
            container.innerHTML = '';

            filteredStocks.forEach(stock => {
                const stockCard = createStockCard(stock);
                container.appendChild(stockCard);
            });
        }

        function createStockCard(stock) {
            const col = document.createElement('div');
            col.className = 'col-md-6 col-lg-4 mb-3';
            
            const currentPrice = stock.current_price || 0;
            const changePercent = stock.change_percent || 0;
            const changeClass = changePercent >= 0 ? 'price-change-positive' : 'price-change-negative';
            
            col.innerHTML = `
                <div class="card stock-card h-100" onclick="window.location.href='/stock/${stock.nse_symbol || stock.bse_symbol}'">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title mb-0">${stock.name || 'N/A'}</h6>
                            <span class="badge bg-secondary sector-badge">${stock.sector || 'N/A'}</span>
                        </div>
                        <p class="card-text text-muted small mb-2">${stock.nse_symbol || stock.bse_symbol}</p>
                        
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="fw-bold">₹${currentPrice.toLocaleString()}</div>
                                <small class="${changeClass}">
                                    ${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%
                                </small>
                            </div>
                            <div class="col-6">
                                <div class="fw-bold">₹${(stock.market_cap / 10000000).toFixed(0)}Cr</div>
                                <small class="text-muted">Market Cap</small>
                            </div>
                        </div>
                        
                        <div class="row mt-2 text-center">
                            <div class="col-4">
                                <small class="text-muted">P/E</small>
                                <div class="fw-bold">${stock.pe_ratio ? stock.pe_ratio.toFixed(1) : 'N/A'}</div>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">P/B</small>
                                <div class="fw-bold">${stock.pb_ratio ? stock.pb_ratio.toFixed(1) : 'N/A'}</div>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">ROE</small>
                                <div class="fw-bold">${stock.roe ? stock.roe.toFixed(1) + '%' : 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            return col;
        }

        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            filterStocks();
        });

        document.getElementById('sectorFilter').addEventListener('change', filterStocks);
        document.getElementById('industryFilter').addEventListener('change', filterStocks);

        function filterStocks() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const sectorFilter = document.getElementById('sectorFilter').value;
            const industryFilter = document.getElementById('industryFilter').value;

            filteredStocks = allStocks.filter(stock => {
                const matchesSearch = !searchTerm || 
                    stock.name?.toLowerCase().includes(searchTerm) ||
                    stock.nse_symbol?.toLowerCase().includes(searchTerm) ||
                    stock.bse_symbol?.toLowerCase().includes(searchTerm);
                
                const matchesSector = !sectorFilter || stock.sector === sectorFilter;
                const matchesIndustry = !industryFilter || stock.industry === industryFilter;

                return matchesSearch && matchesSector && matchesIndustry;
            });

            renderStocks();
        }
    </script>
</body>
</html>
